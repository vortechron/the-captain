# Grafana Terraform Module

This Terraform module deploys Grafana monitoring and visualization platform on Kubernetes using Helm, matching the legacy setup from `k8s/LGTM.md`.

## Features

- Grafana deployment via Helm chart (v9.2.7, matching legacy)
- Persistent storage for dashboards and configurations
- SSL/TLS termination via cert-manager and Let's Encrypt
- Automatic datasource provisioning (Loki and Prometheus)
- Configurable storage class and size
- Resource limits for production stability

## Usage

```hcl
module "grafana" {
  source = "./modules/grafana"

  domain                    = "terapeas.com"
  chart_version             = "9.2.7"
  cluster_issuer_name       = "letsencrypt-prod"
  storage_class             = "managed-premium"
  storage_size              = "10Gi"
  admin_user                = "admin"
  admin_password            = ""  # Leave empty to auto-generate
  loki_datasource_url       = "http://loki-gateway.observability.svc.cluster.local/"
  prometheus_datasource_url = "http://prometheus.observability.svc.cluster.local:9090"
  enable_loki_datasource    = true
  enable_prometheus_datasource = true
}
```

## Requirements

- Kubernetes cluster (AKS in this case)
- nginx ingress controller installed
- cert-manager installed with ClusterIssuer
- Storage class available in cluster
- Helm provider configured in Terraform

## Legacy Setup Compatibility

This module matches the legacy Grafana setup:
- **Chart Version**: 9.2.7 (App v12.0.2)
- **Namespace**: `observability`
- **Helm Repository**: `https://grafana.github.io/helm-charts`
- **Datasources**: Auto-provisioned via ConfigMap with label `grafana_datasource: "1"`

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|----------|
| domain | Base domain for Grafana endpoint | `string` | `"terapeas.com"` | no |
| chart_version | Grafana Helm chart version | `string` | `"9.2.7"` | no |
| cluster_issuer_name | Name of cert-manager ClusterIssuer | `string` | `"letsencrypt-prod"` | no |
| namespace | Kubernetes namespace | `string` | `"observability"` | no |
| storage_class | Storage class for persistent volume | `string` | `"managed-premium"` | no |
| storage_size | Size of persistent volume | `string` | `"10Gi"` | no |
| admin_user | Grafana admin username | `string` | `"admin"` | no |
| admin_password | Grafana admin password (empty = auto-generate) | `string` | `""` | no |
| loki_datasource_url | Loki datasource URL | `string` | `"http://loki-gateway.observability.svc.cluster.local/"` | no |
| prometheus_datasource_url | Prometheus datasource URL | `string` | `"http://prometheus.observability.svc.cluster.local:9090"` | no |
| enable_loki_datasource | Enable Loki datasource provisioning | `bool` | `true` | no |
| enable_prometheus_datasource | Enable Prometheus datasource provisioning | `bool` | `true` | no |
| resources | Resource requests and limits | `object` | See variables.tf | no |

## Outputs

| Name | Description |
|------|-------------|
| namespace | Grafana namespace name |
| grafana_endpoint | Grafana endpoint URL |
| service_name | Grafana service name |
| ingress_name | Grafana ingress name |
| admin_password_command | Command to retrieve admin password |
| admin_user_command | Command to retrieve admin username |
| port_forward_command | Command to port-forward to Grafana |

## Resources Created

- `kubernetes_namespace` - Observability namespace
- `helm_release` - Grafana Helm chart installation
- `kubernetes_ingress_v1` - Ingress with TLS
- `kubernetes_config_map` (x2) - Loki and Prometheus datasources

## Endpoints

After deployment, Grafana will be available at:

- **Web UI**: `https://grafana.aks.{domain}`

## Accessing Grafana

### Get Admin Credentials

```bash
# Get admin password
kubectl get secret --namespace observability grafana -o jsonpath="{.data.admin-password}" | base64 --decode

# Get admin username
kubectl get secret --namespace observability grafana -o jsonpath="{.data.admin-user}" | base64 --decode
```

### Port Forward (Alternative Access)

```bash
kubectl port-forward -n observability svc/grafana 3000:80
```

Then access at `http://localhost:3000`

## Datasources

Datasources are automatically provisioned via ConfigMaps with the label `grafana_datasource: "1"`:

- **Loki**: Default datasource for log aggregation
- **Prometheus**: For metrics visualization

Datasources are configured to match the legacy setup URLs and will be automatically discovered by Grafana.

## DNS Configuration

After deployment, configure DNS record:

```
grafana.aks.{domain} -> [ingress-ip]
```

Get the ingress IP with:

```bash
kubectl get ingress -n observability grafana-ingress
```

## Notes

- Admin password is auto-generated by Helm if not provided
- Storage persistence ensures dashboards and configurations survive pod restarts
- Certificates are automatically provisioned by cert-manager
- Datasources use ConfigMap provisioning (matching legacy setup)
- Module follows the same pattern as MinIO module for consistency

